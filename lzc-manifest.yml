# app çš„å”¯ä¸€ id,ä¸Šæ¶åˆ°å•†åº—éœ€è¦ä¿è¯ä¸è¦å†²çª,å°½é‡ä½¿ç”¨å¼€å‘è€…è‡ªå·±çš„åŸŸåä½œä¸ºåç¼€.
package: cloud.lazycat.app.liu.imagesync
# app çš„ç‰ˆæœ¬
version: 0.0.1

name: Image Sync
keyword: docker, image, snyc
description: é•œåƒåŒæ­¥å·¥å…·ï¼Œæ”¯æŒå¤šç§é•œåƒä»“åº“ä¹‹é—´çš„åŒæ­¥

# è½¯ä»¶åç§°,ä¼šæ˜¾ç¤ºåœ¨å¯åŠ¨å™¨ä¹‹ç±»çš„åœ°æ–¹
locales:
  zh:
    name: OCI é•œåƒåŒæ­¥
    description: |
      ## Image Sync - å®¹å™¨é•œåƒåŒæ­¥å·¥å…·

      åŸºäº Skopeo çš„å®¹å™¨é•œåƒåŒæ­¥å·¥å…·ï¼Œæä¾›ç®€æ´çš„ Web UI ç•Œé¢ï¼Œæ”¯æŒåœ¨ä¸åŒå®¹å™¨é•œåƒä»“åº“ä¹‹é—´å¿«é€ŸåŒæ­¥é•œåƒã€‚

      ## ä¸»è¦åŠŸèƒ½

      - ğŸš€ ç®€å•æ˜“ç”¨çš„ Web UI ç•Œé¢
      - ğŸ” æ”¯æŒç§æœ‰ä»“åº“è®¤è¯ï¼ˆç”¨æˆ·å/å¯†ç ï¼‰
      - ğŸ“¦ åŸºäº Skopeo åº•å±‚å®ç°ï¼Œç¨³å®šå¯é 
      - ğŸ¯ æ”¯æŒè·¨ä»“åº“é•œåƒæ‹·è´
      - ğŸ—ï¸ æ”¯æŒå¤šæ¶æ„é•œåƒåŒæ­¥ï¼ˆå¯æŸ¥è¯¢å¹¶é€‰æ‹©ç‰¹å®šæ¶æ„ï¼‰
      - ğŸ“Š å®æ—¶æ—¥å¿—è¾“å‡ºï¼ŒåŒæ­¥è¿‡ç¨‹ä¸€ç›®äº†ç„¶
      - ğŸ’¾ ç”¨æˆ·é…ç½®ä¿å­˜ä¸ç®¡ç†ï¼ˆæ”¯æŒå¤šé…ç½®å¿«é€Ÿåˆ‡æ¢ï¼‰
      - ğŸ”’ OIDC ç»Ÿä¸€è®¤è¯æ”¯æŒï¼ˆç”¨æˆ·é…ç½®éš”ç¦»ï¼‰
      - ğŸ› å†…ç½®è°ƒè¯•å·¥å…·ï¼Œæ–¹ä¾¿ç§»åŠ¨ç«¯å’Œç”Ÿäº§ç¯å¢ƒæ’éšœ

      ## ä½¿ç”¨è¯´æ˜

      1. å¡«å†™**æºé•œåƒåœ°å€**ï¼ˆä¾‹å¦‚ï¼š`docker.io/library/nginx:latest`ï¼‰
         - å¦‚æœæ˜¯ç§æœ‰ä»“åº“ï¼Œå¡«å†™å¯¹åº”çš„ç”¨æˆ·åå’Œå¯†ç 
         - å¯ä»¥é€‰æ‹©æ˜¯å¦éªŒè¯ TLS è¯ä¹¦ï¼ˆé»˜è®¤ä¼šéªŒè¯ï¼‰

      2. **æŸ¥è¯¢å¯ç”¨æ¶æ„**ï¼ˆå¯é€‰ï¼‰
         - ç‚¹å‡»"æŸ¥è¯¢å¯ç”¨æ¶æ„"æŒ‰é’®æŸ¥çœ‹é•œåƒæ”¯æŒçš„æ‰€æœ‰æ¶æ„
         - æŸ¥è¯¢ç»“æœä¼šä»¥è“è‰²æ ‡ç­¾å½¢å¼æ˜¾ç¤º
         - å¯ä»¥é€‰æ‹©ç‰¹å®šæ¶æ„æˆ–åŒæ­¥æ‰€æœ‰æ¶æ„

      3. å¡«å†™**ç›®æ ‡é•œåƒåœ°å€**ï¼ˆä¾‹å¦‚ï¼š`registry.example.com/nginx:latest`ï¼‰
         - å¦‚æœç›®æ ‡æ˜¯ç§æœ‰ä»“åº“ï¼Œå¡«å†™å¯¹åº”çš„ç”¨æˆ·åå’Œå¯†ç 
         - å¯ä»¥é€‰æ‹©æ˜¯å¦éªŒè¯ TLS è¯ä¹¦

      4. ç‚¹å‡»**å¼€å§‹åŒæ­¥**æŒ‰é’®
         - å®æ—¶æŸ¥çœ‹åŒæ­¥è¿›åº¦å’Œæ—¥å¿—
         - ä»»åŠ¡å®Œæˆåä¼šæ˜¾ç¤ºæˆåŠŸæˆ–å¤±è´¥çŠ¶æ€

      ## é…ç½®ä¿å­˜åŠŸèƒ½

      - é€šè¿‡**é«˜çº§é€‰é¡¹é¢æ¿**å¯ä»¥ä¿å­˜å¸¸ç”¨é…ç½®ï¼Œæ–¹ä¾¿ä¸‹æ¬¡ä½¿ç”¨
      - æ”¯æŒå¤šé…ç½®ç®¡ç†ï¼Œæ¯ä¸ªé…ç½®æœ€å¤§ 4KB
      - æ¯ä¸ªç”¨æˆ·æœ€å¤šä¿å­˜ 1000 ä¸ªé…ç½®
      - å¯ç”¨ OIDC è®¤è¯åï¼Œé…ç½®è‡ªåŠ¨éš”ç¦»ï¼Œæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ç®¡ç†
      - **å¯†ç ä¿å­˜æ§åˆ¶**ï¼šé»˜è®¤ä¸ä¿å­˜å¯†ç ï¼ˆæè‡´å®‰å…¨ï¼‰ï¼Œå¯é€šè¿‡é…ç½®å¯ç”¨

      ## å®‰å…¨ç‰¹æ€§

      ### é˜²æŠ¤æœºåˆ¶
      - âœ… **å‘½ä»¤æ³¨å…¥é˜²æŠ¤**ï¼šä¸ç»è¿‡ shellï¼Œä»æ ¹æœ¬ä¸Šé¿å…å‘½ä»¤æ³¨å…¥é£é™©
      - âœ… **è¾“å…¥éªŒè¯**ï¼šæ‰€æœ‰ç”¨æˆ·è¾“å…¥ç»è¿‡ä¸¥æ ¼çš„ç™½åå•éªŒè¯ï¼ˆæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ ‡å‡†é•œåƒåœ°å€æ ¼å¼ï¼‰
      - âœ… **å‚æ•°æ³¨å…¥é˜²æŠ¤**ï¼šæ‹’ç»åŒ…å« shell å…ƒå­—ç¬¦çš„è¾“å…¥ï¼Œé˜²æ­¢å‚æ•°æ³¨å…¥æ”»å‡»
      - âœ… **DoS é˜²æŠ¤**ï¼šé™åˆ¶è¾“å…¥é•¿åº¦ï¼ˆé•œåƒåœ°å€ 512 å­—ç¬¦ï¼Œç”¨æˆ·å 256 å­—ç¬¦ï¼‰ï¼Œé˜²æ­¢å†…å­˜è€—å°½æ”»å‡»

      ### å‡­æ®å®‰å…¨
      - âœ… **å¯†ç é»˜è®¤ä¸ä¿å­˜**ï¼šé…ç½®ä¿å­˜åŠŸèƒ½é»˜è®¤ç¦æ­¢å­˜å‚¨å¯†ç ï¼ˆ`--allow-password-save=false`ï¼‰ï¼Œç¡®ä¿é…ç½®æ–‡ä»¶ä¸­ä¸åŒ…å«æ•æ„Ÿå‡­æ®
      - âœ… **æ—¥å¿—è‡ªåŠ¨è„±æ•**ï¼šæ‰€æœ‰æ—¥å¿—è¾“å‡ºä¸­çš„å‡­æ®ä¿¡æ¯è‡ªåŠ¨æ›¿æ¢ä¸º `***:***`ï¼Œé˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²
      - âœ… **HTTPS ä¼ è¾“**ï¼šç”Ÿäº§ç¯å¢ƒå‡­æ®é€šè¿‡ HTTPS POST è¯·æ±‚ä½“ä¼ è¾“ï¼Œä¸é€šè¿‡ URL å‚æ•°
      - âœ… **å†…å­˜ä¸´æ—¶å­˜å‚¨**ï¼šå‡­æ®ä»…åœ¨æ‰§è¡Œ Skopeo æ—¶ä¸´æ—¶ä½¿ç”¨ï¼Œä¸æŒä¹…åŒ–åˆ°ç£ç›˜

      ### ç”¨æˆ·éš”ç¦»
      - âœ… **OIDC ç»Ÿä¸€è®¤è¯**ï¼šä¸ Lazycat Cloud å¾®æœè®¤è¯ç³»ç»Ÿé›†æˆï¼Œè‡ªåŠ¨éªŒè¯ç”¨æˆ·èº«ä»½
      - âœ… **é…ç½®éš”ç¦»**ï¼šæ¯ä¸ªç”¨æˆ·çš„é…ç½®å­˜å‚¨åœ¨ç‹¬ç«‹ç›®å½•ï¼Œå®Œå…¨éš”ç¦»äº’ä¸å½±å“
      - âœ… **ä¼šè¯ç®¡ç†**ï¼šHttpOnly Cookieï¼Œ7 å¤©æœ‰æ•ˆæœŸï¼Œè‡ªåŠ¨è¿‡æœŸæ¸…ç†
      - âœ… **è®¿é—®æ§åˆ¶**ï¼šæ‰€æœ‰é•œåƒåŒæ­¥ API å‡éœ€è®¤è¯ï¼Œæœªè®¤è¯è®¿é—®è‡ªåŠ¨è·³è½¬ç™»å½•

      ### èµ„æºé™åˆ¶
      - âœ… **é…ç½®å¤§å°é™åˆ¶**ï¼šå•ä¸ªé…ç½®æœ€å¤§ 4KBï¼Œé˜²æ­¢å­˜å‚¨ç©ºé—´æ»¥ç”¨
      - âœ… **é…ç½®æ•°é‡é™åˆ¶**ï¼šæ¯ä¸ªç”¨æˆ·æœ€å¤š 1000 ä¸ªé…ç½®ï¼Œé˜²æ­¢ DoS æ”»å‡»
      - âœ… **è¶…æ—¶æ§åˆ¶**ï¼šé»˜è®¤ 10 åˆ†é’Ÿè¶…æ—¶ï¼Œé˜²æ­¢ä»»åŠ¡æ— é™æ‰§è¡Œæ¶ˆè€—èµ„æº

  en:
    name: OCI Image Sync
    description: |
      ## Image Sync - Container Image Synchronization Tool

      A container image synchronization tool based on Skopeo, providing a clean Web UI interface that supports fast image synchronization between different container registries.

      ## Key Features

      - ğŸš€ Simple and easy-to-use Web UI interface
      - ğŸ” Private registry authentication support (username/password)
      - ğŸ“¦ Built on Skopeo for stable and reliable performance
      - ğŸ¯ Cross-registry image copying support
      - ğŸ—ï¸ Multi-architecture image synchronization (query and select specific architectures)
      - ğŸ“Š Real-time log output for transparent sync process
      - ğŸ’¾ User configuration save and management (quick switching between multiple configs)
      - ğŸ”’ OIDC unified authentication support (user configuration isolation)
      - ğŸ› Built-in debugging tools for mobile and production troubleshooting

      ## Usage Instructions

      1. Fill in **Source Image Address** (e.g., `docker.io/library/nginx:latest`)
         - For private registries, provide username and password
         - Choose whether to verify TLS certificates (verified by default)

      2. **Query Available Architectures** (optional)
         - Click "Query Architectures" button to view all supported architectures
         - Results displayed as blue tags
         - Select specific architecture or sync all architectures

      3. Fill in **Destination Image Address** (e.g., `registry.example.com/nginx:latest`)
         - For private registries, provide username and password
         - Choose whether to verify TLS certificates

      4. Click **Start Sync** button
         - View sync progress and logs in real-time
         - Success or failure status displayed upon completion

      ## Configuration Save Feature

      - Save frequently-used configurations via **Advanced Options Panel**
      - Multi-configuration management support, max 4KB per config
      - Maximum 1000 configs per user
      - With OIDC authentication enabled, configs are automatically isolated per user
      - **Password Save Control**: Passwords not saved by default (maximum security), can be enabled via configuration

      ## Security Features

      ### Protection Mechanisms
      - âœ… **Command Injection Protection**: No shell execution, fundamentally prevents command injection
      - âœ… **Input Validation**: All user inputs strictly validated with whitelist (regex matching standard image address format)
      - âœ… **Parameter Injection Protection**: Rejects inputs containing shell metacharacters to prevent parameter injection attacks
      - âœ… **DoS Protection**: Input length limits (512 chars for image addresses, 256 chars for usernames) prevent memory exhaustion attacks

      ### Credential Security
      - âœ… **Passwords Not Saved by Default**: Config save feature disables password storage by default (`--allow-password-save=false`), ensuring no sensitive credentials in config files
      - âœ… **Automatic Log Sanitization**: All credential information in logs automatically replaced with `***:***` to prevent sensitive data leakage
      - âœ… **HTTPS Transmission**: Production environment credentials transmitted via HTTPS POST request body, not URL parameters
      - âœ… **Temporary Memory Storage**: Credentials only used temporarily during Skopeo execution, not persisted to disk

      ### User Isolation
      - âœ… **OIDC Unified Authentication**: Integrated with Lazycat Cloud microservice authentication system, automatic user identity verification
      - âœ… **Configuration Isolation**: Each user's configurations stored in separate directories, completely isolated
      - âœ… **Session Management**: HttpOnly Cookie, 7-day validity, automatic expiration cleanup
      - âœ… **Access Control**: All image sync APIs require authentication, unauthenticated access automatically redirects to login

      ### Resource Limits
      - âœ… **Config Size Limit**: Maximum 4KB per config, prevents storage space abuse
      - âœ… **Config Count Limit**: Maximum 1000 configs per user, prevents DoS attacks
      - âœ… **Timeout Control**: Default 10-minute timeout, prevents infinite task execution consuming resources

# è½¯ä»¶æœ¬èº«çš„ license
license: https://choosealicense.com/licenses/mit/

# è½¯ä»¶çš„ä¸»é¡µ,ä¼šåœ¨å•†åº—ç­‰åœ°æ–¹ä½“ç°
homepage: https://github.com/lazycatapps/image-sync

# lpk çš„ä½œè€…,ä¼šåœ¨å•†åº—ç­‰åœ°æ–¹ä½“ç°
author: liu

# application ä½œä¸ºä¸€ä¸ªç‰¹æ®Šçš„ container è¿è¡Œï¼Œå¯¹åº”çš„ service åç§°ä¸ºå›ºå®šçš„`app`ï¼Œ å…¶ä»– service å¯ä»¥é€šè¿‡æ­¤åç§°ä¸ app è¿›è¡Œé€šè®¯
application:
  #æ˜¯å¦å­˜åœ¨åå°ä»»åŠ¡ï¼Œ è‹¥å­˜åœ¨åˆ™ç³»ç»Ÿä¸ä¼šå¯¹æ­¤ app è¿›è¡Œä¸»åŠ¨ä¼‘çœ ç­‰æ“ä½œ
  background_task: false

  # æœŸæœ›çš„ app åŸŸåï¼Œå¦‚æœç³»ç»Ÿä¸­å·²ç»æœ‰å¯¹åº”åŸŸååˆ™ä¼šæç¤ºç”¨æˆ·é€‰æ‹©å…¶ä»–åŸŸåã€‚ æœ€ç»ˆ app åˆ†é…åˆ°çš„åŸŸåä»¥/lzcapp/run/app.subdomain ä¸ºå‡†
  subdomain: imagesync

  # OIDC è®¤è¯å›è°ƒè·¯å¾„
  oidc_redirect_path: /api/v1/auth/callback

  routes:
    - /=file:///lzcapp/pkg/content/web
    - /api/=http://backend.cloud.lazycat.app.liu.imagesync.lzcapp:59901/api/

  depends_on:
    - backend

  # æ˜¯å¦å¯ç”¨å¤šå®ä¾‹
  multi_instance: false

services:
  # init:
  #   image: ##IMAGE_PLACEHOLDER##
  #   # image: docker-registry-ui.${LAZYCAT_BOX_NAME}.heiyu.space/image-sync/backend:latest
  #   user: root
  #   binds:
  #     - /lzcapp/var/configs:/configs
  #   entrypoint: /bin/sh
  #   command: -c "chown -R 65532:65532 /configs"

  backend:
    image: ##IMAGE_PLACEHOLDER##
    # image: docker-registry-ui.${LAZYCAT_BOX_NAME}.heiyu.space/image-sync/backend:latest
    # Currently only root can create configs directory and write files
    user: 65532
    # Ref: https://developer.lazycat.cloud/advanced-setupscript.html
    setup_script: |
      chown -R 65532:65532 /configs
    environment:
      # æœåŠ¡ç›‘å¬é…ç½®
      - SYNC_HOST=host.lzcapp
      - SYNC_PORT=59901

      # åŒæ­¥ä»»åŠ¡é…ç½®
      - SYNC_TIMEOUT=600  # åŒæ­¥è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 600

      # é»˜è®¤é•œåƒä»“åº“åœ°å€
      # - SYNC_DEFAULT_SOURCE_REGISTRY=registry.lazycat.cloud/lzc/lzcapp:3.20.3-1
      # - SYNC_DEFAULT_DEST_REGISTRY=docker-registry-ui.${LAZYCAT_BOX_NAME}.heiyu.space/alpine:latest

      # CORS è·¨åŸŸé…ç½®
      - SYNC_CORS_ALLOWED_ORIGINS=http://host.lzcapp:59901,https://${LAZYCAT_APP_DOMAIN}

      # ç”¨æˆ·é…ç½®å­˜å‚¨è®¾ç½®
      - SYNC_CONFIG_DIR=/configs  # é…ç½®æ–‡ä»¶å­˜å‚¨ç›®å½•ï¼Œé»˜è®¤ /configs
      - SYNC_ALLOW_PASSWORD_SAVE=false  # æ˜¯å¦å…è®¸ä¿å­˜å¯†ç åˆ°é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ falseï¼ˆæè‡´å®‰å…¨ï¼‰
      - SYNC_MAX_CONFIG_SIZE=4096  # å•ä¸ªé…ç½®æ–‡ä»¶æœ€å¤§å¤§å°ï¼ˆå­—èŠ‚ï¼‰ï¼Œé»˜è®¤ 4096
      - SYNC_MAX_CONFIG_FILES=1000  # æ¯ä¸ªç”¨æˆ·æœ€å¤§é…ç½®æ–‡ä»¶æ•°é‡ï¼Œé»˜è®¤ 1000

      # æ—¶åŒºé…ç½®
      - TZ=Asia/Shanghai

      # OIDC è®¤è¯é…ç½®ï¼ˆè‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€æ‰‹åŠ¨ä¿®æ”¹ï¼‰
      - SYNC_OIDC_CLIENT_ID=${LAZYCAT_AUTH_OIDC_CLIENT_ID}
      - SYNC_OIDC_CLIENT_SECRET=${LAZYCAT_AUTH_OIDC_CLIENT_SECRET}
      - SYNC_OIDC_ISSUER=${LAZYCAT_AUTH_OIDC_ISSUER_URI}
      - SYNC_OIDC_REDIRECT_URL=https://${LAZYCAT_APP_DOMAIN}/api/v1/auth/callback
    # ä½¿ç”¨ä¸»æœºç½‘ç»œæ¨¡å¼ è€ƒè™‘ registry.lazycat.cloud çš„é•œåƒæ—¶éœ€è¦ç”¨åˆ°
    network_mode: "host"
    health_check:
      test_url: http://host.lzcapp:59901/api/v1/health
      start_period: 30s
      disable: false
    binds:
      - /lzcapp/var/configs:/configs
